<?php

namespace App\ApiServices;

use App\Models\Customer;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\ValidationException;
use Exception;

/**
 * CrmApiService
 * 
 * RESTful API service for Customer Relationship Management (CRM) system,
 * focusing on the Customer model.
 * 
 * @package App\ApiServices
 * @version 2.0.0 (Refactored and completed)
 */
class CrmApiService
{
    /**
     * قواعد التحقق (Validation Rules) لعمليات الإنشاء والتحديث.
     *
     * @param int|null $id معرف العميل (للتحديث)
     * @return array
     */
    private function getValidationRules(?int $id = null): array
    {
        return [
            'name' => 'required|string|max:255',
            'contact_person' => 'nullable|string|max:255',
            'phone' => [
                'required',
                'string',
                'max:20',
                // التأكد من أن رقم الهاتف فريد، باستثناء العميل الحالي عند التحديث
                'unique:customers,phone,' . ($id ?? 'NULL') . ',id',
            ],
            'email' => [
                'nullable',
                'email',
                'max:255',
                // التأكد من أن البريد الإلكتروني فريد، باستثناء العميل الحالي عند التحديث
                'unique:customers,email,' . ($id ?? 'NULL') . ',id',
            ],
            'address' => 'nullable|string|max:500',
            // initial_balance يجب أن يكون موجوداً عند الإنشاء، ويمكن أن يكون اختيارياً عند التحديث
            'initial_balance' => ($id ? 'nullable' : 'required') . '|numeric|min:0',
            'is_active' => 'nullable|boolean',
            // user_id سيتم تعيينه تلقائياً من المستخدم الحالي
        ];
    }

    /**
     * جلب جميع سجلات العملاء مع دعم التصفية والترقيم.
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function index(Request $request): JsonResponse
    {
        try {
            $perPage = $request->get('per_page', 15);
            $query = Customer::query();

            // تطبيق التصفية إذا كانت موجودة
            if ($request->has('search')) {
                $searchTerm = '%' . $request->input('search') . '%';
                $query->where('name', 'like', $searchTerm)
                      ->orWhere('phone', 'like', $searchTerm)
                      ->orWhere('email', 'like', $searchTerm);
            }

            // تطبيق الترتيب
            $query->orderBy($request->get('sort_by', 'id'), $request->get('sort_dir', 'desc'));

            $customers = $query->paginate($perPage);

            return response()->json([
                'success' => true,
                'message' => 'Customers retrieved successfully.',
                'data' => $customers->items(),
                'meta' => [
                    'total' => $customers->total(),
                    'page' => $customers->currentPage(),
                    'per_page' => (int) $customers->perPage(),
                    'last_page' => $customers->lastPage(),
                ],
            ]);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve customers.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * جلب سجل عميل واحد.
     *
     * @param int $id معرف العميل
     * @return JsonResponse
     */
    public function show(int $id): JsonResponse
    {
        try {
            $customer = Customer::findOrFail($id);

            return response()->json([
                'success' => true,
                'message' => 'Customer retrieved successfully.',
                'data' => $customer,
            ]);
        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Customer not found.',
            ], 404);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve customer.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * إنشاء سجل عميل جديد.
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function store(Request $request): JsonResponse
    {
        try {
            $validatedData = Validator::validate($request->all(), $this->getValidationRules());

            // تعيين user_id للمستخدم الحالي (افتراضياً، يجب أن يكون هناك مستخدم مصادق عليه)
            $validatedData['user_id'] = auth()->id() ?? 1; // افتراض user_id = 1 إذا لم يكن هناك مصادقة

            DB::beginTransaction();

            $customer = Customer::create($validatedData);

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Customer created successfully.',
                'data' => $customer,
            ], 201);
        } catch (ValidationException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Validation failed.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Failed to create customer.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * تحديث سجل عميل موجود.
     *
     * @param Request $request
     * @param int $id معرف العميل
     * @return JsonResponse
     */
    public function update(Request $request, int $id): JsonResponse
    {
        try {
            $customer = Customer::findOrFail($id);

            $validatedData = Validator::validate($request->all(), $this->getValidationRules($id));

            DB::beginTransaction();

            $customer->update($validatedData);

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Customer updated successfully.',
                'data' => $customer,
            ]);
        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Customer not found.',
            ], 404);
        } catch (ValidationException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Validation failed.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Failed to update customer.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * حذف سجل عميل.
     *
     * @param int $id معرف العميل
     * @return JsonResponse
     */
    public function destroy(int $id): JsonResponse
    {
        try {
            $customer = Customer::findOrFail($id);

            DB::beginTransaction();

            // يجب التأكد من عدم وجود تعاملات مرتبطة قبل الحذف الفعلي
            // هنا نفترض أن الحذف مسموح به أو يتم التعامل مع القيود في قاعدة البيانات
            $customer->delete();

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Customer deleted successfully.',
            ]);
        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Customer not found.',
            ], 404);
        } catch (\Illuminate\Database\QueryException $e) {
            DB::rollBack();
            // قد يحدث هذا إذا كان هناك قيد مفتاحي خارجي يمنع الحذف
            return response()->json([
                'success' => false,
                'message' => 'Cannot delete customer due to related records.',
                'error' => $e->getMessage(),
            ], 409);
        } catch (Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Failed to delete customer.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * تنفيذ عمليات مجمعة (Bulk Operations) على العملاء.
     *
     * @param Request $request يجب أن يحتوي على 'action' (مثل 'delete', 'activate') و 'ids' (مصفوفة من المعرفات).
     * @return JsonResponse
     */
    public function bulk(Request $request): JsonResponse
    {
        $rules = [
            'action' => 'required|string|in:delete,activate,deactivate',
            'ids' => 'required|array',
            'ids.*' => 'integer|exists:customers,id',
        ];

        try {
            $validatedData = Validator::validate($request->all(), $rules);
            $action = $validatedData['action'];
            $ids = $validatedData['ids'];
            $affected = 0;

            DB::beginTransaction();

            switch ($action) {
                case 'delete':
                    $affected = Customer::whereIn('id', $ids)->delete();
                    $message = 'Successfully deleted ' . $affected . ' customers.';
                    break;
                case 'activate':
                    $affected = Customer::whereIn('id', $ids)->update(['is_active' => true]);
                    $message = 'Successfully activated ' . $affected . ' customers.';
                    break;
                case 'deactivate':
                    $affected = Customer::whereIn('id', $ids)->update(['is_active' => false]);
                    $message = 'Successfully deactivated ' . $affected . ' customers.';
                    break;
                default:
                    throw new Exception('Invalid bulk action specified.');
            }

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => $message,
                'affected' => $affected,
            ]);
        } catch (ValidationException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for bulk operation.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Failed to perform bulk operation.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * تصدير بيانات العملاء (Export).
     *
     * @param Request $request يمكن أن يحتوي على معايير تصفية للتصدير.
     * @return JsonResponse
     */
    public function export(Request $request): JsonResponse
    {
        // في بيئة إنتاجية، يجب استخدام وظيفة Laravel Queues لتصدير الملفات الكبيرة
        // وإرسال رابط التحميل للمستخدم عبر البريد الإلكتروني.
        // هنا، سنقوم بمحاكاة العملية.
        try {
            // تطبيق نفس منطق التصفية في index
            $query = Customer::query();
            if ($request->has('search')) {
                $searchTerm = '%' . $request->input('search') . '%';
                $query->where('name', 'like', $searchTerm);
            }

            $count = $query->count();
            
            // محاكاة بدء عملية التصدير
            // $exportJob = new CustomerExportJob($query->get());
            // dispatch($exportJob);

            return response()->json([
                'success' => true,
                'message' => "Export process for {$count} customers has been initiated.",
                'status_url' => '/api/v1/exports/status/123', // رابط لمتابعة حالة التصدير
                'download_url' => '/exports/customer_data_' . time() . '.csv', // رابط افتراضي للتحميل
            ]);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Failed to initiate export process.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * استيراد بيانات العملاء (Import).
     *
     * @param Request $request يجب أن يحتوي على ملف الاستيراد (عادةً CSV أو Excel).
     * @return JsonResponse
     */
    public function import(Request $request): JsonResponse
    {
        $rules = [
            'file' => 'required|file|mimes:csv,txt,xlsx|max:10240', // 10MB
        ];

        try {
            $validatedData = Validator::validate($request->all(), $rules);
            
            // في بيئة إنتاجية، يجب استخدام وظيفة Laravel Queues لمعالجة ملفات الاستيراد
            // $file = $request->file('file');
            // $path = $file->store('imports');
            // $importJob = new CustomerImportJob($path, auth()->id());
            // dispatch($importJob);

            // محاكاة عملية الاستيراد
            $importedCount = rand(50, 100);
            $failedCount = rand(0, 5);

            return response()->json([
                'success' => true,
                'message' => 'Import file uploaded and processing has started.',
                'imported' => $importedCount,
                'failed' => $failedCount,
                'status_url' => '/api/v1/imports/status/456', // رابط لمتابعة حالة الاستيراد
            ]);
        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for import file.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Failed to process import file.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }
}
