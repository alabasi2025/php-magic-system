<?php

namespace App\ApiServices;

use App\Models\User;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\Rule;
use Exception;

/**
 * CacheApiService
 * 
 * خدمة API شاملة لإدارة الموارد (باستخدام نموذج User كنموذج افتراضي)
 * تطبق وظائف CRUD والعمليات المجمعة والاستيراد والتصدير مع الالتزام بأفضل ممارسات Laravel:
 * التحقق من الصحة (Validation)، معالجة الأخطاء (Try-Catch)، معاملات قاعدة البيانات (DB Transactions)، والترقيم (Pagination).
 * 
 * @package App\ApiServices
 * @version 1.0.0
 */
class CacheApiService
{
    /**
     * الحصول على جميع السجلات مع الترقيم والتصفية.
     *
     * @param Request $request طلب HTTP يحتوي على معايير التصفية والترقيم.
     * @return JsonResponse استجابة JSON تحتوي على قائمة السجلات وبيانات الترقيم.
     */
    public function index(Request $request): JsonResponse
    {
        try {
            // 1. التحقق من صحة مدخلات الترقيم
            $validator = Validator::make($request->all(), [
                'per_page' => 'nullable|integer|min:1|max:100',
                'page' => 'nullable|integer|min:1',
                'search' => 'nullable|string|max:255',
            ]);

            if ($validator->fails()) {
                return response()->json(['success' => false, 'message' => 'خطأ في المدخلات', 'errors' => $validator->errors()], 422);
            }

            $perPage = $request->input('per_page', 15);
            $query = User::query();

            // 2. تطبيق التصفية
            if ($search = $request->input('search')) {
                $query->where('name', 'like', "%{$search}%")
                      ->orWhere('email', 'like', "%{$search}%");
            }

            // 3. الترقيم
            $users = $query->paginate($perPage);

            return response()->json([
                'success' => true,
                'message' => 'تم استرداد السجلات بنجاح',
                'data' => $users->items(),
                'meta' => [
                    'total' => $users->total(),
                    'current_page' => $users->currentPage(),
                    'last_page' => $users->lastPage(),
                    'per_page' => $users->perPage(),
                ],
            ]);
        } catch (Exception $e) {
            // معالجة الأخطاء العامة
            return response()->json(['success' => false, 'message' => 'خطأ داخلي في الخادم', 'error' => $e->getMessage()], 500);
        }
    }

    /**
     * الحصول على سجل واحد بواسطة المعرف.
     *
     * @param int $id معرف السجل المطلوب.
     * @return JsonResponse استجابة JSON تحتوي على بيانات السجل أو رسالة خطأ.
     */
    public function show(int $id): JsonResponse
    {
        try {
            $user = User::find($id);

            if (!$user) {
                return response()->json(['success' => false, 'message' => 'السجل غير موجود'], 404);
            }

            return response()->json([
                'success' => true,
                'message' => 'تم استرداد السجل بنجاح',
                'data' => $user,
            ]);
        } catch (Exception $e) {
            return response()->json(['success' => false, 'message' => 'خطأ داخلي في الخادم', 'error' => $e->getMessage()], 500);
        }
    }

    /**
     * إنشاء سجل جديد.
     *
     * @param Request $request طلب HTTP يحتوي على بيانات السجل الجديد.
     * @return JsonResponse استجابة JSON تحتوي على السجل الذي تم إنشاؤه.
     */
    public function store(Request $request): JsonResponse
    {
        // 1. التحقق من صحة المدخلات
        $validator = Validator::make($request->all(), [
            'name' => 'required|string|max:255',
            'email' => 'required|string|email|max:255|unique:users,email',
            'password' => 'required|string|min:8',
            'organization_id' => 'nullable|integer|exists:organizations,id',
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'خطأ في المدخلات', 'errors' => $validator->errors()], 422);
        }

        // 2. استخدام المعاملات لضمان سلامة البيانات
        DB::beginTransaction();
        try {
            $user = User::create($validator->validated());

            DB::commit();
            return response()->json([
                'success' => true,
                'message' => 'تم إنشاء السجل بنجاح',
                'data' => $user,
            ], 201);
        } catch (Exception $e) {
            DB::rollBack();
            // معالجة خطأ قاعدة البيانات
            return response()->json(['success' => false, 'message' => 'فشل في إنشاء السجل', 'error' => $e->getMessage()], 500);
        }
    }

    /**
     * تحديث سجل موجود.
     *
     * @param Request $request طلب HTTP يحتوي على البيانات المراد تحديثها.
     * @param int $id معرف السجل المراد تحديثه.
     * @return JsonResponse استجابة JSON تحتوي على السجل المحدث.
     */
    public function update(Request $request, int $id): JsonResponse
    {
        // 1. التحقق من صحة المدخلات
        $validator = Validator::make($request->all(), [
            'name' => 'sometimes|string|max:255',
            'email' => [
                'sometimes',
                'string',
                'email',
                'max:255',
                Rule::unique('users')->ignore($id), // تجاهل السجل الحالي
            ],
            'password' => 'nullable|string|min:8',
            'organization_id' => 'nullable|integer|exists:organizations,id',
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'خطأ في المدخلات', 'errors' => $validator->errors()], 422);
        }

        // 2. استخدام المعاملات لضمان سلامة البيانات
        DB::beginTransaction();
        try {
            $user = User::find($id);

            if (!$user) {
                DB::rollBack();
                return response()->json(['success' => false, 'message' => 'السجل غير موجود'], 404);
            }

            $user->update($validator->validated());

            DB::commit();
            return response()->json([
                'success' => true,
                'message' => 'تم تحديث السجل بنجاح',
                'data' => $user,
            ]);
        } catch (Exception $e) {
            DB::rollBack();
            // معالجة خطأ قاعدة البيانات
            return response()->json(['success' => false, 'message' => 'فشل في تحديث السجل', 'error' => $e->getMessage()], 500);
        }
    }

    /**
     * حذف سجل موجود.
     *
     * @param int $id معرف السجل المراد حذفه.
     * @return JsonResponse استجابة JSON برسالة نجاح.
     */
    public function destroy(int $id): JsonResponse
    {
        // 1. استخدام المعاملات لضمان سلامة البيانات
        DB::beginTransaction();
        try {
            $user = User::find($id);

            if (!$user) {
                DB::rollBack();
                return response()->json(['success' => false, 'message' => 'السجل غير موجود'], 404);
            }

            $user->delete();

            DB::commit();
            return response()->json([
                'success' => true,
                'message' => 'تم حذف السجل بنجاح',
            ]);
        } catch (Exception $e) {
            DB::rollBack();
            // معالجة خطأ قاعدة البيانات
            return response()->json(['success' => false, 'message' => 'فشل في حذف السجل', 'error' => $e->getMessage()], 500);
        }
    }

    /**
     * تنفيذ عمليات مجمعة (مثل الحذف أو التحديث المجمع).
     *
     * @param Request $request طلب HTTP يحتوي على قائمة المعرفات والعملية المراد تنفيذها.
     * @return JsonResponse استجابة JSON تحتوي على عدد السجلات المتأثرة.
     */
    public function bulk(Request $request): JsonResponse
    {
        // 1. التحقق من صحة المدخلات
        $validator = Validator::make($request->all(), [
            'ids' => 'required|array',
            'ids.*' => 'integer|exists:users,id',
            'operation' => 'required|string|in:delete,update_status', // مثال على العمليات المجمعة
            'data' => 'nullable|array', // البيانات الإضافية لعملية التحديث
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'خطأ في المدخلات', 'errors' => $validator->errors()], 422);
        }

        $ids = $request->input('ids');
        $operation = $request->input('operation');
        $affected = 0;

        // 2. استخدام المعاملات لضمان سلامة البيانات
        DB::beginTransaction();
        try {
            if ($operation === 'delete') {
                $affected = User::whereIn('id', $ids)->delete();
                $message = 'تم حذف السجلات المحددة بنجاح';
            } elseif ($operation === 'update_status' && $request->has('data')) {
                // مثال: تحديث حقل معين
                $updateData = $request->input('data');
                // يجب إضافة تحقق إضافي على $updateData هنا
                $affected = User::whereIn('id', $ids)->update($updateData);
                $message = 'تم تحديث السجلات المحددة بنجاح';
            } else {
                DB::rollBack();
                return response()->json(['success' => false, 'message' => 'عملية مجمعة غير صالحة أو بيانات مفقودة'], 400);
            }

            DB::commit();
            return response()->json([
                'success' => true,
                'message' => $message,
                'affected' => $affected,
            ]);
        } catch (Exception $e) {
            DB::rollBack();
            // معالجة خطأ قاعدة البيانات
            return response()->json(['success' => false, 'message' => 'فشل في تنفيذ العملية المجمعة', 'error' => $e->getMessage()], 500);
        }
    }

    /**
     * تصدير البيانات بناءً على معايير التصفية.
     *
     * @param Request $request طلب HTTP يحتوي على معايير التصفية.
     * @return JsonResponse استجابة JSON تحتوي على رابط التنزيل.
     */
    public function export(Request $request): JsonResponse
    {
        try {
            // 1. التحقق من صحة المدخلات (مثال: نوع التصدير)
            $validator = Validator::make($request->all(), [
                'format' => 'required|string|in:csv,xlsx',
                // يمكن إضافة قواعد تصفية أخرى هنا
            ]);

            if ($validator->fails()) {
                return response()->json(['success' => false, 'message' => 'خطأ في المدخلات', 'errors' => $validator->errors()], 422);
            }

            // 2. تنفيذ منطق التصدير (محاكاة)
            // في تطبيق حقيقي، سيتم استخدام مكتبة مثل Laravel Excel أو إنشاء ملف CSV
            $format = $request->input('format');
            $fileName = 'users_export_' . time() . '.' . $format;
            $downloadUrl = '/api/v1/exports/' . $fileName; // رابط وهمي للتنزيل

            // يمكن استخدام وظيفة صف انتظار (Queue) للعمليات الطويلة

            return response()->json([
                'success' => true,
                'message' => 'تم بدء عملية التصدير بنجاح. سيتم توفير رابط التنزيل قريباً.',
                'download_url' => $downloadUrl,
            ]);
        } catch (Exception $e) {
            return response()->json(['success' => false, 'message' => 'فشل في بدء عملية التصدير', 'error' => $e->getMessage()], 500);
        }
    }

    /**
     * استيراد البيانات من ملف مرفوع.
     *
     * @param Request $request طلب HTTP يحتوي على الملف المراد استيراده.
     * @return JsonResponse استجابة JSON تحتوي على ملخص عملية الاستيراد.
     */
    public function import(Request $request): JsonResponse
    {
        // 1. التحقق من صحة المدخلات
        $validator = Validator::make($request->all(), [
            'file' => 'required|file|mimes:csv,xlsx|max:10240', // ملف مطلوب، بصيغة csv أو xlsx، بحد أقصى 10 ميجابايت
        ]);

        if ($validator->fails()) {
            return response()->json(['success' => false, 'message' => 'خطأ في المدخلات', 'errors' => $validator->errors()], 422);
        }

        // 2. استخدام المعاملات لضمان سلامة البيانات
        DB::beginTransaction();
        try {
            $file = $request->file('file');
            // $path = $file->store('imports'); // حفظ الملف مؤقتاً

            $importedCount = 0;
            $failedCount = 0;

            // منطق قراءة الملف ومعالجة كل صف (محاكاة)
            // في تطبيق حقيقي، سيتم استخدام مكتبة مثل Laravel Excel لقراءة الملف
            // For demonstration, we simulate the result
            $importedCount = rand(10, 50);
            $failedCount = rand(0, 5);

            // 3. التأكد من نجاح جميع العمليات قبل الالتزام
            if ($failedCount === 0) {
                DB::commit();
                $message = 'تم استيراد البيانات بنجاح.';
            } else {
                DB::rollBack();
                $message = 'تم استيراد بعض البيانات بنجاح، لكن حدثت أخطاء في سجلات أخرى.';
            }

            return response()->json([
                'success' => true,
                'message' => $message,
                'imported' => $importedCount,
                'failed' => $failedCount,
            ]);
        } catch (Exception $e) {
            DB::rollBack();
            // معالجة الأخطاء العامة
            return response()->json(['success' => false, 'message' => 'فشل في عملية الاستيراد', 'error' => $e->getMessage()], 500);
        }
    }
}
