<?php

namespace App\ApiServices;

use App\Models\Project;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\ValidationException;
use Exception;

/**
 * ProjectsApiService
 *
 * خدمة API شاملة لإدارة مشاريع النظام.
 * تطبق أفضل الممارسات في Laravel مثل التحقق من الصحة، ومعاملات قاعدة البيانات، ومعالجة الأخطاء الشاملة.
 *
 * @package App\ApiServices
 * @version 1.0.0
 */
class ProjectsApiService
{
    /**
     * جلب جميع السجلات مع دعم التصفح (Pagination).
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function index(Request $request): JsonResponse
    {
        try {
            $perPage = $request->get('per_page', 15);
            $projects = Project::paginate($perPage);

            return response()->json([
                'success' => true,
                'message' => 'تم جلب قائمة المشاريع بنجاح.',
                'data' => $projects->items(),
                'meta' => [
                    'total' => $projects->total(),
                    'current_page' => $projects->currentPage(),
                    'per_page' => (int) $projects->perPage(),
                    'last_page' => $projects->lastPage(),
                ],
            ]);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في جلب قائمة المشاريع.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * جلب سجل واحد محدد بواسطة المعرف (ID).
     *
     * @param int $id
     * @return JsonResponse
     */
    public function show(int $id): JsonResponse
    {
        try {
            $project = Project::find($id);

            if (!$project) {
                return response()->json([
                    'success' => false,
                    'message' => 'المشروع غير موجود.',
                ], 404);
            }

            return response()->json([
                'success' => true,
                'message' => 'تم جلب بيانات المشروع بنجاح.',
                'data' => $project,
            ]);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في جلب بيانات المشروع.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * إنشاء سجل جديد.
     *
     * يتطلب التحقق من صحة المدخلات واستخدام معاملة قاعدة بيانات (DB Transaction).
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function store(Request $request): JsonResponse
    {
        $rules = [
            'name' => 'required|string|max:255|unique:projects,name',
            'description' => 'nullable|string',
            'status' => 'required|in:pending,active,completed,cancelled',
            'start_date' => 'nullable|date',
            'end_date' => 'nullable|date|after_or_equal:start_date',
        ];

        try {
            $validatedData = $request->validate($rules);

            $project = DB::transaction(function () use ($validatedData) {
                return Project::create($validatedData);
            });

            return response()->json([
                'success' => true,
                'message' => 'تم إنشاء المشروع بنجاح.',
                'data' => $project,
            ], 201);

        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل التحقق من صحة البيانات.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في إنشاء المشروع.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * تحديث سجل موجود.
     *
     * يتطلب التحقق من صحة المدخلات واستخدام معاملة قاعدة بيانات (DB Transaction).
     *
     * @param Request $request
     * @param int $id
     * @return JsonResponse
     */
    public function update(Request $request, int $id): JsonResponse
    {
        $rules = [
            'name' => 'sometimes|string|max:255|unique:projects,name,' . $id,
            'description' => 'nullable|string',
            'status' => 'sometimes|in:pending,active,completed,cancelled',
            'start_date' => 'nullable|date',
            'end_date' => 'nullable|date|after_or_equal:start_date',
        ];

        try {
            $project = Project::find($id);

            if (!$project) {
                return response()->json([
                    'success' => false,
                    'message' => 'المشروع غير موجود.',
                ], 404);
            }

            $validatedData = $request->validate($rules);

            DB::transaction(function () use ($project, $validatedData) {
                $project->update($validatedData);
            });

            return response()->json([
                'success' => true,
                'message' => 'تم تحديث المشروع بنجاح.',
                'data' => $project->fresh(),
            ]);

        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل التحقق من صحة البيانات.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في تحديث المشروع.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * حذف سجل محدد.
     *
     * يستخدم معاملة قاعدة بيانات (DB Transaction).
     *
     * @param int $id
     * @return JsonResponse
     */
    public function destroy(int $id): JsonResponse
    {
        try {
            $deleted = DB::transaction(function () use ($id) {
                $project = Project::find($id);

                if (!$project) {
                    return false;
                }

                return $project->delete();
            });

            if (!$deleted) {
                return response()->json([
                    'success' => false,
                    'message' => 'المشروع غير موجود أو فشل في الحذف.',
                ], 404);
            }

            return response()->json([
                'success' => true,
                'message' => 'تم حذف المشروع بنجاح.',
            ]);

        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في حذف المشروع.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * عمليات مجمعة (Bulk Operations) مثل الحذف أو التحديث المتعدد.
     *
     * يتطلب التحقق من صحة المدخلات واستخدام معاملة قاعدة بيانات (DB Transaction).
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function bulk(Request $request): JsonResponse
    {
        $rules = [
            'operation' => 'required|in:delete,update_status',
            'ids' => 'required|array',
            'ids.*' => 'integer|exists:projects,id',
            'status' => 'required_if:operation,update_status|in:pending,active,completed,cancelled',
        ];

        try {
            $validatedData = $request->validate($rules);
            $affectedCount = 0;

            DB::transaction(function () use ($validatedData, &$affectedCount) {
                $ids = $validatedData['ids'];
                $operation = $validatedData['operation'];

                if ($operation === 'delete') {
                    $affectedCount = Project::whereIn('id', $ids)->delete();
                } elseif ($operation === 'update_status') {
                    $affectedCount = Project::whereIn('id', $ids)->update(['status' => $validatedData['status']]);
                }
            });

            return response()->json([
                'success' => true,
                'message' => "تمت عملية '{$validatedData['operation']}' المجمعة بنجاح.",
                'affected' => $affectedCount,
            ]);

        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل التحقق من صحة البيانات للعملية المجمعة.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في تنفيذ العملية المجمعة.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * تصدير البيانات (Export).
     *
     * يقوم بإنشاء ملف CSV أو Excel (كمثال) وإرجاع رابط التحميل.
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function export(Request $request): JsonResponse
    {
        // في تطبيق حقيقي، سيتم استخدام مكتبة مثل Laravel Excel لتوليد الملف
        // وتنفيذ العملية في طابور (Queue) إذا كانت البيانات كبيرة.
        // هنا، نكتفي بإرجاع استجابة ناجحة مع رابط وهمي.
        try {
            // يمكن إضافة منطق تصفية هنا بناءً على $request
            // $projects = Project::query()->where(...)->get();

            $fileName = 'projects_export_' . time() . '.csv';
            $filePath = '/exports/' . $fileName;

            // منطق توليد الملف الفعلي يوضع هنا

            return response()->json([
                'success' => true,
                'message' => 'تم بدء عملية التصدير بنجاح.',
                'download_url' => $filePath,
            ]);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في عملية التصدير.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * استيراد البيانات (Import).
     *
     * يتطلب التحقق من صحة ملف الاستيراد واستخدام معاملة قاعدة بيانات (DB Transaction).
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function import(Request $request): JsonResponse
    {
        $rules = [
            'file' => 'required|file|mimes:csv,txt,xlsx|max:10240', // 10MB limit
        ];

        try {
            $request->validate($rules);

            // في تطبيق حقيقي، سيتم استخدام مكتبة مثل Laravel Excel لمعالجة الملف
            // وتنفيذ العملية في طابور (Queue) إذا كانت البيانات كبيرة.
            // هنا، نكتفي بمحاكاة العملية.

            $importedCount = 0;
            $failedCount = 0;

            // محاكاة عملية الاستيراد داخل معاملة
            DB::transaction(function () use (&$importedCount, &$failedCount) {
                // $file = $request->file('file');
                // منطق قراءة الملف وإنشاء/تحديث السجلات يوضع هنا
                // For simulation:
                $importedCount = rand(10, 50);
                $failedCount = rand(0, 5);
            });

            return response()->json([
                'success' => true,
                'message' => 'تمت عملية الاستيراد بنجاح.',
                'imported' => $importedCount,
                'failed' => $failedCount,
            ]);

        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل التحقق من صحة ملف الاستيراد.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في عملية الاستيراد.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }
}
