<?php

namespace App\ApiServices;

use App\Models\Payroll;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\ValidationException;
use Symfony\Component\HttpFoundation\Response;

/**
 * PayrollApiService
 * 
 * RESTful API service for Payroll system. Implements secure CRUD, bulk operations,
 * export, and import functionalities following Laravel best practices (Validation,
 * Transactions, Error Handling, Pagination).
 * 
 * @package App\ApiServices
 * @version 1.0.0
 */
class PayrollApiService
{
    /**
     * قواعد التحقق الأساسية لعمليات الإنشاء والتحديث.
     *
     * @var array
     */
    protected array $validationRules = [
        'employee_id' => 'required|integer|exists:employees,id', // افتراض وجود جدول Employees
        'amount' => 'required|numeric|min:0',
        'pay_date' => 'required|date',
        'status' => 'nullable|string|in:paid,pending,failed',
    ];

    /**
     * جلب جميع سجلات كشوف المرتبات مع التصفح (Pagination).
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function index(Request $request): JsonResponse
    {
        try {
            $perPage = $request->get('per_page', 15);
            $payrolls = Payroll::paginate($perPage);

            return response()->json([
                'success' => true,
                'message' => 'Payrolls retrieved successfully.',
                'data' => $payrolls->items(),
                'meta' => [
                    'total' => $payrolls->total(),
                    'current_page' => $payrolls->currentPage(),
                    'last_page' => $payrolls->lastPage(),
                    'per_page' => (int) $payrolls->perPage(),
                ],
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve payrolls.',
                'error' => $e->getMessage(),
            ], Response::HTTP_INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * جلب سجل كشف مرتب واحد.
     *
     * @param int $id معرف كشف المرتب
     * @return JsonResponse
     */
    public function show(int $id): JsonResponse
    {
        try {
            $payroll = Payroll::findOrFail($id);

            return response()->json([
                'success' => true,
                'message' => 'Payroll retrieved successfully.',
                'data' => $payroll,
            ]);
        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Payroll not found.',
            ], Response::HTTP_NOT_FOUND);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve payroll.',
                'error' => $e->getMessage(),
            ], Response::HTTP_INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * إنشاء سجل كشف مرتب جديد.
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function store(Request $request): JsonResponse
    {
        try {
            $validatedData = Validator::make($request->all(), $this->validationRules)->validate();

            DB::beginTransaction();
            $payroll = Payroll::create($validatedData);
            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Payroll created successfully.',
                'data' => $payroll,
            ], Response::HTTP_CREATED);

        } catch (ValidationException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Validation failed.',
                'errors' => $e->errors(),
            ], Response::HTTP_UNPROCESSABLE_ENTITY);
        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Failed to create payroll.',
                'error' => $e->getMessage(),
            ], Response::HTTP_INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * تحديث سجل كشف مرتب موجود.
     *
     * @param Request $request
     * @param int $id معرف كشف المرتب
     * @return JsonResponse
     */
    public function update(Request $request, int $id): JsonResponse
    {
        try {
            $payroll = Payroll::findOrFail($id);
            
            // دمج قواعد التحقق مع استثناء حقل employee_id من التحديث إذا لم يتم إرساله
            $rules = $this->validationRules;
            if (!$request->has('employee_id')) {
                unset($rules['employee_id']);
            }
            
            $validatedData = Validator::make($request->all(), $rules)->validate();

            DB::beginTransaction();
            $payroll->update($validatedData);
            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Payroll updated successfully.',
                'data' => $payroll,
            ]);

        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Payroll not found.',
            ], Response::HTTP_NOT_FOUND);
        } catch (ValidationException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Validation failed.',
                'errors' => $e->errors(),
            ], Response::HTTP_UNPROCESSABLE_ENTITY);
        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Failed to update payroll.',
                'error' => $e->getMessage(),
            ], Response::HTTP_INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * حذف سجل كشف مرتب.
     *
     * @param int $id معرف كشف المرتب
     * @return JsonResponse
     */
    public function destroy(int $id): JsonResponse
    {
        try {
            $payroll = Payroll::findOrFail($id);

            DB::beginTransaction();
            $payroll->delete();
            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Payroll deleted successfully.',
            ]);

        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Payroll not found.',
            ], Response::HTTP_NOT_FOUND);
        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Failed to delete payroll.',
                'error' => $e->getMessage(),
            ], Response::HTTP_INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * عمليات مجمعة (Bulk Operations) على كشوف المرتبات.
     *
     * تدعم هذه الوظيفة عمليات مجمعة مثل الحذف أو التحديث بناءً على قائمة من المعرفات.
     *
     * @param Request $request يجب أن يحتوي على 'operation' (مثل 'delete' أو 'update') و 'ids' (قائمة معرفات) أو 'data' للتحديث.
     * @return JsonResponse
     */
    public function bulk(Request $request): JsonResponse
    {
        $rules = [
            'operation' => 'required|string|in:delete,update,status_change',
            'ids' => 'required_if:operation,delete,status_change|array',
            'ids.*' => 'integer',
            'data' => 'required_if:operation,update|array',
        ];

        try {
            $validated = Validator::make($request->all(), $rules)->validate();
            $operation = $validated['operation'];
            $ids = $validated['ids'] ?? [];
            $affected = 0;

            DB::beginTransaction();

            if ($operation === 'delete') {
                $affected = Payroll::whereIn('id', $ids)->delete();
                $message = "Successfully deleted {$affected} payroll records.";
            } elseif ($operation === 'update') {
                // مثال: تحديث حقل معين (مثل status) لجميع السجلات المحددة
                $updateRules = [
                    'data.status' => 'required|string|in:paid,pending,failed',
                ];
                $updateData = Validator::make($validated['data'], $updateRules)->validate();
                
                $affected = Payroll::whereIn('id', $ids)->update($updateData['data']);
                $message = "Successfully updated {$affected} payroll records.";
            } elseif ($operation === 'status_change') {
                // مثال: تغيير حالة الدفع
                $statusRules = [
                    'new_status' => 'required|string|in:paid,pending,failed',
                ];
                $statusData = Validator::make($request->all(), $statusRules)->validate();
                
                $affected = Payroll::whereIn('id', $ids)->update(['status' => $statusData['new_status']]);
                $message = "Successfully changed status for {$affected} payroll records.";
            } else {
                DB::rollBack();
                return response()->json([
                    'success' => false,
                    'message' => 'Invalid bulk operation specified.',
                ], Response::HTTP_BAD_REQUEST);
            }

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => $message,
                'affected' => $affected,
            ]);

        } catch (ValidationException $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for bulk operation.',
                'errors' => $e->errors(),
            ], Response::HTTP_UNPROCESSABLE_ENTITY);
        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Failed to perform bulk operation.',
                'error' => $e->getMessage(),
            ], Response::HTTP_INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * تصدير بيانات كشوف المرتبات.
     *
     * يقوم بإنشاء ملف تصدير (CSV/Excel) وإرجاع رابط التحميل.
     *
     * @param Request $request يمكن أن يحتوي على 'format' (csv, xlsx) و 'filters'.
     * @return JsonResponse
     */
    public function export(Request $request): JsonResponse
    {
        // في بيئة حقيقية، سيتم استخدام وظيفة تصدير (مثل Laravel Excel)
        // وتنفيذها كعملية في الخلفية (Job) لتجنب تجاوز وقت التنفيذ.
        try {
            $format = $request->get('format', 'csv');
            $validFormats = ['csv', 'xlsx'];

            if (!in_array($format, $validFormats)) {
                return response()->json([
                    'success' => false,
                    'message' => 'Invalid export format. Supported formats: ' . implode(', ', $validFormats),
                ], Response::HTTP_BAD_REQUEST);
            }

            // محاكاة عملية التصدير
            $filename = 'payrolls_export_' . time() . '.' . $format;
            $downloadUrl = '/storage/exports/' . $filename;

            // هنا يتم إطلاق Job للتصدير الفعلي
            // ExportJob::dispatch($request->all(), $filename, auth()->user());

            return response()->json([
                'success' => true,
                'message' => 'Export process started successfully. You will be notified when the file is ready.',
                'download_url' => $downloadUrl, // هذا الرابط سيكون صالحًا بعد اكتمال Job
            ], Response::HTTP_ACCEPTED);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Failed to start export process.',
                'error' => $e->getMessage(),
            ], Response::HTTP_INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * استيراد بيانات كشوف المرتبات.
     *
     * يقبل ملفًا (CSV/Excel) ويبدأ عملية الاستيراد.
     *
     * @param Request $request يجب أن يحتوي على ملف 'file' و 'import_type'.
     * @return JsonResponse
     */
    public function import(Request $request): JsonResponse
    {
        $rules = [
            'file' => 'required|file|mimes:csv,xlsx|max:10240', // 10MB Max
            'import_type' => 'required|string|in:create_only,update_or_create',
        ];

        try {
            $validated = Validator::make($request->all(), $rules)->validate();

            // في بيئة حقيقية، يتم تخزين الملف مؤقتًا وإطلاق Job للاستيراد
            // $path = $request->file('file')->store('temp_imports');
            
            // محاكاة عملية الاستيراد
            $importedCount = rand(10, 50);
            $failedCount = rand(0, 5);

            // ImportJob::dispatch($path, $validated['import_type'], auth()->user());

            return response()->json([
                'success' => true,
                'message' => 'Import process started successfully. You will be notified upon completion.',
                'imported' => $importedCount, // هذه الأرقام ستكون من Job الفعلي
                'failed' => $failedCount,
            ], Response::HTTP_ACCEPTED);

        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for import operation.',
                'errors' => $e->errors(),
            ], Response::HTTP_UNPROCESSABLE_ENTITY);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Failed to start import process.',
                'error' => $e->getMessage(),
            ], Response::HTTP_INTERNAL_SERVER_ERROR);
        }
    }
}
