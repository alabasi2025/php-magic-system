<?php

namespace App\ApiServices;

use App\Models\Manufacturing;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\ValidationException;
use Exception;

/**
 * ManufacturingApiService
 * 
 * RESTful API service for Manufacturing system.
 * This service implements all standard CRUD operations (index, show, store, update, destroy)
 * along with bulk operations, data export, and data import, following Laravel best practices
 * for security, transactions, and error handling.
 * 
 * @package App\ApiServices
 * @version 1.0.0
 */
class ManufacturingApiService
{
    /**
     * Define validation rules for the store operation.
     *
     * @return array
     */
    private function storeRules(): array
    {
        return [
            'name' => 'required|string|max:255',
            'quantity' => 'required|integer|min:1',
            'status' => 'required|string|in:pending,in_progress,completed',
        ];
    }

    /**
     * Define validation rules for the update operation.
     *
     * @param int $id The ID of the record being updated (can be used for unique checks)
     * @return array
     */
    private function updateRules(int $id): array
    {
        return [
            'name' => 'sometimes|required|string|max:255',
            'quantity' => 'sometimes|required|integer|min:1',
            'status' => 'sometimes|required|string|in:pending,in_progress,completed',
        ];
    }

    /**
     * Get all manufacturing records with pagination.
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function index(Request $request): JsonResponse
    {
        try {
            $perPage = $request->get('per_page', 15);
            $query = Manufacturing::query();

            // Simple filtering example
            if ($request->has('status')) {
                $query->where('status', $request->get('status'));
            }

            $records = $query->paginate($perPage);

            return response()->json([
                'success' => true,
                'data' => $records->items(),
                'meta' => [
                    'total' => $records->total(),
                    'page' => $records->currentPage(),
                    'per_page' => $records->perPage(),
                    'last_page' => $records->lastPage(),
                ],
            ]);
        } catch (Exception $e) {
            Log::error("ManufacturingApiService index error: " . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve records.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Get a single manufacturing record by ID.
     *
     * @param int $id
     * @return JsonResponse
     */
    public function show(int $id): JsonResponse
    {
        try {
            $record = Manufacturing::findOrFail($id);

            return response()->json([
                'success' => true,
                'data' => $record,
            ]);
        } catch (ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => "Record with ID {$id} not found.",
            ], 404);
        } catch (Exception $e) {
            Log::error("ManufacturingApiService show error: " . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve record.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Create a new manufacturing record.
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function store(Request $request): JsonResponse
    {
        try {
            $validatedData = Validator::make($request->all(), $this->storeRules())->validate();

            $record = DB::transaction(function () use ($validatedData) {
                return Manufacturing::create($validatedData);
            });

            return response()->json([
                'success' => true,
                'message' => 'Manufacturing record created successfully.',
                'data' => $record,
            ], 201);

        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            Log::error("ManufacturingApiService store error: " . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to create record.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Update an existing manufacturing record.
     *
     * @param Request $request
     * @param int $id
     * @return JsonResponse
     */
    public function update(Request $request, int $id): JsonResponse
    {
        try {
            $record = Manufacturing::findOrFail($id);
            
            $validatedData = Validator::make($request->all(), $this->updateRules($id))->validate();

            DB::transaction(function () use ($record, $validatedData) {
                $record->update($validatedData);
            });

            return response()->json([
                'success' => true,
                'message' => "Manufacturing record with ID {$id} updated successfully.",
                'data' => $record->fresh(),
            ]);

        } catch (ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => "Record with ID {$id} not found.",
            ], 404);
        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            Log::error("ManufacturingApiService update error: " . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to update record.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Delete a manufacturing record.
     *
     * @param int $id
     * @return JsonResponse
     */
    public function destroy(int $id): JsonResponse
    {
        try {
            $deleted = DB::transaction(function () use ($id) {
                $record = Manufacturing::findOrFail($id);
                return $record->delete();
            });

            if ($deleted) {
                return response()->json([
                    'success' => true,
                    'message' => "Manufacturing record with ID {$id} deleted successfully.",
                ]);
            }

            // Should not be reached if findOrFail succeeds, but for safety
            return response()->json([
                'success' => false,
                'message' => "Failed to delete record with ID {$id}.",
            ], 500);

        } catch (ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => "Record with ID {$id} not found.",
            ], 404);
        } catch (Exception $e) {
            Log::error("ManufacturingApiService destroy error: " . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to delete record.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Perform bulk operations (e.g., delete, update status) on multiple records.
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function bulk(Request $request): JsonResponse
    {
        $rules = [
            'operation' => 'required|string|in:delete,update_status',
            'ids' => 'required|array',
            'ids.*' => 'integer|exists:manufacturing,id', // Assumes table name is 'manufacturing'
            'status' => 'required_if:operation,update_status|string|in:pending,in_progress,completed',
        ];

        try {
            $validatedData = Validator::make($request->all(), $rules)->validate();
            $operation = $validatedData['operation'];
            $ids = $validatedData['ids'];
            $affected = 0;

            DB::transaction(function () use ($operation, $ids, $validatedData, &$affected) {
                if ($operation === 'delete') {
                    $affected = Manufacturing::whereIn('id', $ids)->delete();
                } elseif ($operation === 'update_status') {
                    $affected = Manufacturing::whereIn('id', $ids)->update(['status' => $validatedData['status']]);
                }
            });

            return response()->json([
                'success' => true,
                'message' => "Bulk operation '{$operation}' completed successfully.",
                'affected' => $affected,
            ]);

        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for bulk operation.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            Log::error("ManufacturingApiService bulk error: " . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to perform bulk operation.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Export data to a file (e.g., CSV).
     *
     * NOTE: In a real application, this would typically queue a job and return a download link.
     * Here, we simulate the success of the export process.
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function export(Request $request): JsonResponse
    {
        try {
            // TODO: Implement actual export logic (e.g., using a package like Laravel Excel)
            // For now, we simulate the process.
            $count = Manufacturing::count();
            
            // Simulate queuing an export job
            // ExportJob::dispatch($request->all()); 

            return response()->json([
                'success' => true,
                'message' => "Export of {$count} records has been queued.",
                'download_url' => '/api/manufacturing/export/status?job_id=123', // Placeholder for status check
            ]);
        } catch (Exception $e) {
            Log::error("ManufacturingApiService export error: " . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to queue export job.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Import data from an uploaded file.
     *
     * NOTE: In a real application, this would typically queue a job for processing the file.
     * Here, we simulate the success of the import process.
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function import(Request $request): JsonResponse
    {
        $rules = [
            'file' => 'required|file|mimes:csv,xlsx|max:10240', // Max 10MB
        ];

        try {
            $validatedData = Validator::make($request->all(), $rules)->validate();
            
            // TODO: Implement actual file handling and import logic (e.g., using Laravel Excel)
            $fileName = $validatedData['file']->getClientOriginalName();
            
            // Simulate moving the file and dispatching an import job
            // $path = $validatedData['file']->store('imports');
            // ImportJob::dispatch($path);

            return response()->json([
                'success' => true,
                'message' => "Import file '{$fileName}' received and import job has been queued.",
                'imported' => 0, // Will be updated by the job
                'failed' => 0,   // Will be updated by the job
            ]);

        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed for import file.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            Log::error("ManufacturingApiService import error: " . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to process import file.',
                'error' => $e->getMessage(),
            ], 500);
        }
    }
}
