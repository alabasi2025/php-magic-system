<?php

namespace App\ApiServices;

use App\Models\Compliance; // افتراض اسم النموذج بناءً على نمط التسمية
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\ValidationException;
use Exception;

/**
 * ComplianceApiService
 *
 * خدمة API RESTful لنظام الامتثال (Compliance).
 * تم إصلاحها وتطبيق أفضل ممارسات Laravel عليها.
 *
 * @package App\ApiServices
 * @version 1.0.1
 */
class ComplianceApiService
{
    /**
     * جلب جميع سجلات الامتثال مع ترقيم الصفحات والتصفية.
     *
     * @param Request $request طلب HTTP يحتوي على معايير البحث والترقيم.
     * @return JsonResponse
     */
    public function index(Request $request): JsonResponse
    {
        try {
            $perPage = $request->get('per_page', 15);
            $query = Compliance::query();

            // تطبيق البحث والتصفية
            if ($request->has('search')) {
                $searchTerm = '%' . $request->input('search') . '%';
                $query->where('name', 'like', $searchTerm)
                      ->orWhere('description', 'like', $searchTerm);
            }

            $compliances = $query->paginate($perPage);

            return response()->json([
                'success' => true,
                'message' => 'تم جلب سجلات الامتثال بنجاح.',
                'data' => $compliances->items(),
                'meta' => [
                    'total' => $compliances->total(),
                    'page' => $compliances->currentPage(),
                    'per_page' => $compliances->perPage(),
                    'last_page' => $compliances->lastPage(),
                ],
            ]);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في جلب السجلات: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * جلب سجل امتثال واحد بواسطة المعرف (ID).
     *
     * @param int $id معرف سجل الامتثال.
     * @return JsonResponse
     */
    public function show(int $id): JsonResponse
    {
        try {
            $compliance = Compliance::findOrFail($id);

            return response()->json([
                'success' => true,
                'message' => 'تم جلب سجل الامتثال بنجاح.',
                'data' => $compliance,
            ]);
        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => 'السجل غير موجود.',
            ], 404);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في جلب السجل: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * إنشاء سجل امتثال جديد.
     *
     * @param Request $request بيانات السجل الجديد.
     * @return JsonResponse
     */
    public function store(Request $request): JsonResponse
    {
        try {
            $validatedData = $request->validate([
                'name' => 'required|string|max:255',
                'description' => 'nullable|string',
                'status' => 'required|in:pending,approved,rejected',
                // إضافة قواعد تحقق أخرى حسب الحاجة
            ]);

            DB::beginTransaction();

            $compliance = Compliance::create($validatedData);

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'تم إنشاء سجل الامتثال بنجاح.',
                'data' => $compliance,
            ], 201);
        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل التحقق من البيانات.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'فشل في إنشاء السجل: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * تحديث سجل امتثال موجود.
     *
     * @param Request $request البيانات المحدثة.
     * @param int $id معرف سجل الامتثال المراد تحديثه.
     * @return JsonResponse
     */
    public function update(Request $request, int $id): JsonResponse
    {
        try {
            $compliance = Compliance::findOrFail($id);

            $validatedData = $request->validate([
                'name' => 'sometimes|required|string|max:255',
                'description' => 'nullable|string',
                'status' => 'sometimes|required|in:pending,approved,rejected',
            ]);

            DB::beginTransaction();

            $compliance->update($validatedData);

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'تم تحديث سجل الامتثال بنجاح.',
                'data' => $compliance,
            ]);
        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => 'السجل غير موجود.',
            ], 404);
        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل التحقق من البيانات.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'فشل في تحديث السجل: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * حذف سجل امتثال.
     *
     * @param int $id معرف سجل الامتثال المراد حذفه.
     * @return JsonResponse
     */
    public function destroy(int $id): JsonResponse
    {
        try {
            $compliance = Compliance::findOrFail($id);

            DB::beginTransaction();

            $compliance->delete();

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'تم حذف سجل الامتثال بنجاح.',
            ]);
        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => 'السجل غير موجود.',
            ], 404);
        } catch (Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'فشل في حذف السجل: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * تنفيذ عمليات مجمعة (Bulk Operations) على سجلات الامتثال.
     *
     * @param Request $request طلب HTTP يحتوي على قائمة المعرفات والعملية المراد تنفيذها.
     * @return JsonResponse
     */
    public function bulk(Request $request): JsonResponse
    {
        try {
            $validatedData = $request->validate([
                'ids' => 'required|array',
                'ids.*' => 'integer|exists:compliances,id', // افتراض اسم الجدول 'compliances'
                'action' => 'required|in:delete,update_status',
                'status' => 'required_if:action,update_status|in:pending,approved,rejected',
            ]);

            $ids = $validatedData['ids'];
            $action = $validatedData['action'];
            $affected = 0;

            DB::beginTransaction();

            if ($action === 'delete') {
                $affected = Compliance::whereIn('id', $ids)->delete();
                $message = 'تم حذف ' . $affected . ' سجل امتثال بنجاح.';
            } elseif ($action === 'update_status') {
                $status = $validatedData['status'];
                $affected = Compliance::whereIn('id', $ids)->update(['status' => $status]);
                $message = 'تم تحديث حالة ' . $affected . ' سجل امتثال إلى ' . $status . ' بنجاح.';
            } else {
                throw new Exception('عملية مجمعة غير صالحة.');
            }

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => $message,
                'affected' => $affected,
            ]);
        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل التحقق من البيانات للعملية المجمعة.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'فشل في تنفيذ العملية المجمعة: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * تصدير سجلات الامتثال.
     *
     * @param Request $request معايير التصدير (مثل التصفية).
     * @return JsonResponse
     */
    public function export(Request $request): JsonResponse
    {
        try {
            // في تطبيق حقيقي، يتم وضع هذه العملية في وظيفة (Job) أو حدث (Event)
            // لتجنب تجاوز وقت التنفيذ. هنا، سنقوم بمحاكاة بسيطة.

            $query = Compliance::query();
            // تطبيق أي تصفية من $request هنا

            $count = $query->count();
            // محاكاة إنشاء ملف التصدير
            $filePath = '/exports/compliance_' . time() . '.csv';
            // Logic to generate CSV/Excel file goes here...

            return response()->json([
                'success' => true,
                'message' => 'تم بدء عملية التصدير بنجاح. سيتم إرسال رابط التحميل قريباً.',
                'total_records' => $count,
                'download_url' => $filePath, // رابط وهمي
            ]);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في عملية التصدير: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * استيراد سجلات الامتثال من ملف.
     *
     * @param Request $request طلب HTTP يحتوي على الملف المراد استيراده.
     * @return JsonResponse
     */
    public function import(Request $request): JsonResponse
    {
        try {
            $validatedData = $request->validate([
                'file' => 'required|file|mimes:csv,txt,xlsx|max:10240', // 10MB
            ]);

            // في تطبيق حقيقي، يتم وضع هذه العملية في وظيفة (Job)
            // لمعالجة الملف بشكل غير متزامن. هنا، سنقوم بمحاكاة بسيطة.

            $file = $request->file('file');
            $fileName = $file->getClientOriginalName();
            // Logic to process the file and import data goes here...

            // محاكاة نتائج الاستيراد
            $importedCount = rand(10, 50);
            $failedCount = rand(0, 5);

            return response()->json([
                'success' => true,
                'message' => 'تم استلام ملف الاستيراد (' . $fileName . ') بنجاح. سيتم معالجته قريباً.',
                'imported' => $importedCount,
                'failed' => $failedCount,
            ]);
        } catch (ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل التحقق من البيانات لعملية الاستيراد.',
                'errors' => $e->errors(),
            ], 422);
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'فشل في عملية الاستيراد: ' . $e->getMessage(),
            ], 500);
        }
    }
}
