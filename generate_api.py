#!/usr/bin/env python3
"""
API Generator v3.16.0
Auto-generates RESTful API for all Laravel models

@version 3.16.0
@author SEMOP Team
@date 2025-12-03
"""

import os
import re
from pathlib import Path
from datetime import datetime


class ApiGenerator:
    def __init__(self, base_path):
        self.base_path = Path(base_path)
        self.models_path = self.base_path / 'app' / 'Models'
        self.controllers_path = self.base_path / 'app' / 'Http' / 'Controllers' / 'Api'
        self.routes_path = self.base_path / 'routes'
        
        self.models = []
        self.generated_controllers = []
        self.stats = {
            'models_found': 0,
            'controllers_generated': 0,
            'routes_generated': 0,
            'errors': []
        }
    
    def log(self, message):
        """Print log message"""
        print(f"[API Generator] {message}")
    
    def discover_models(self):
        """Discover all PHP models in the project"""
        self.log('Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù†Ù…Ø§Ø°Ø¬...')
        
        for php_file in self.models_path.rglob('*.php'):
            relative_path = php_file.relative_to(self.models_path)
            class_name = str(relative_path.with_suffix('')).replace(os.sep, '\\')
            base_name = php_file.stem
            
            self.models.append({
                'name': class_name,
                'base_name': base_name,
                'file_path': str(php_file),
                'full_class': f'App\\Models\\{class_name}'
            })
        
        self.stats['models_found'] = len(self.models)
        self.log(f"ØªÙ… Ø§ÙƒØªØ´Ø§Ù {self.stats['models_found']} Ù†Ù…ÙˆØ°Ø¬")
    
    def to_kebab_case(self, text):
        """Convert text to kebab-case"""
        # Insert hyphen before uppercase letters
        s1 = re.sub('(.)([A-Z][a-z]+)', r'\1-\2', text)
        # Insert hyphen before uppercase letters preceded by lowercase
        return re.sub('([a-z0-9])([A-Z])', r'\1-\2', s1).lower()
    
    def to_camel_case(self, text):
        """Convert text to camelCase"""
        return text[0].lower() + text[1:] if text else text
    
    def pluralize(self, text):
        """Simple pluralization"""
        if text.endswith('y'):
            return text[:-1] + 'ies'
        elif text.endswith('s'):
            return text + 'es'
        else:
            return text + 's'
    
    def generate_controller_content(self, model):
        """Generate controller content for a model"""
        base_name = model['base_name']
        model_class = model['full_class']
        controller_name = f"{base_name}ApiController"
        resource_name = self.to_kebab_case(self.pluralize(base_name))
        variable_name = self.to_camel_case(base_name)
        plural_variable = self.to_camel_case(self.pluralize(base_name))
        today = datetime.now().strftime('%Y-%m-%d')
        
        return f'''<?php

namespace App\\Http\\Controllers\\Api;

use App\\Http\\Controllers\\Controller;
use {model_class};
use Illuminate\\Http\\Request;
use Illuminate\\Http\\JsonResponse;

/**
 * {controller_name}
 * 
 * RESTful API Controller for {base_name}
 * Auto-generated by API Generator v3.16.0
 * 
 * @version 3.16.0
 * @date {today}
 */
class {controller_name} extends Controller
{{
    /**
     * Display a listing of the resource.
     * 
     * @OA\\Get(
     *     path="/api/{resource_name}",
     *     summary="Get all {base_name} records",
     *     tags={{"{base_name}"}},
     *     @OA\\Response(response=200, description="Success")
     * )
     */
    public function index(Request $request): JsonResponse
    {{
        try {{
            $perPage = $request->get('per_page', 15);
            $page = $request->get('page', 1);
            
            ${plural_variable} = {base_name}::query()
                ->when($request->has('search'), function ($query) use ($request) {{
                    $search = $request->get('search');
                    // Add searchable fields here
                    return $query->where('id', 'like', "%{{$search}}%");
                }})
                ->paginate($perPage, ['*'], 'page', $page);

            return response()->json([
                'success' => true,
                'data' => ${plural_variable}->items(),
                'meta' => [
                    'current_page' => ${plural_variable}->currentPage(),
                    'per_page' => ${plural_variable}->perPage(),
                    'total' => ${plural_variable}->total(),
                    'last_page' => ${plural_variable}->lastPage(),
                ]
            ]);
        }} catch (\\Exception $e) {{
            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve records',
                'error' => $e->getMessage()
            ], 500);
        }}
    }}

    /**
     * Store a newly created resource in storage.
     * 
     * @OA\\Post(
     *     path="/api/{resource_name}",
     *     summary="Create a new {base_name}",
     *     tags={{"{base_name}"}},
     *     @OA\\Response(response=201, description="Created")
     * )
     */
    public function store(Request $request): JsonResponse
    {{
        try {{
            $validated = $request->validate([
                // Add validation rules here
            ]);

            ${variable_name} = {base_name}::create($validated);

            return response()->json([
                'success' => true,
                'message' => '{base_name} created successfully',
                'data' => ${variable_name}
            ], 201);
        }} catch (\\Exception $e) {{
            return response()->json([
                'success' => false,
                'message' => 'Failed to create {base_name}',
                'error' => $e->getMessage()
            ], 500);
        }}
    }}

    /**
     * Display the specified resource.
     * 
     * @OA\\Get(
     *     path="/api/{resource_name}/{{id}}",
     *     summary="Get a specific {base_name}",
     *     tags={{"{base_name}"}},
     *     @OA\\Parameter(name="id", in="path", required=true, @OA\\Schema(type="integer")),
     *     @OA\\Response(response=200, description="Success")
     * )
     */
    public function show($id): JsonResponse
    {{
        try {{
            ${variable_name} = {base_name}::findOrFail($id);

            return response()->json([
                'success' => true,
                'data' => ${variable_name}
            ]);
        }} catch (\\Exception $e) {{
            return response()->json([
                'success' => false,
                'message' => '{base_name} not found',
                'error' => $e->getMessage()
            ], 404);
        }}
    }}

    /**
     * Update the specified resource in storage.
     * 
     * @OA\\Put(
     *     path="/api/{resource_name}/{{id}}",
     *     summary="Update a {base_name}",
     *     tags={{"{base_name}"}},
     *     @OA\\Parameter(name="id", in="path", required=true, @OA\\Schema(type="integer")),
     *     @OA\\Response(response=200, description="Success")
     * )
     */
    public function update(Request $request, $id): JsonResponse
    {{
        try {{
            ${variable_name} = {base_name}::findOrFail($id);
            
            $validated = $request->validate([
                // Add validation rules here
            ]);

            ${variable_name}->update($validated);

            return response()->json([
                'success' => true,
                'message' => '{base_name} updated successfully',
                'data' => ${variable_name}
            ]);
        }} catch (\\Exception $e) {{
            return response()->json([
                'success' => false,
                'message' => 'Failed to update {base_name}',
                'error' => $e->getMessage()
            ], 500);
        }}
    }}

    /**
     * Remove the specified resource from storage.
     * 
     * @OA\\Delete(
     *     path="/api/{resource_name}/{{id}}",
     *     summary="Delete a {base_name}",
     *     tags={{"{base_name}"}},
     *     @OA\\Parameter(name="id", in="path", required=true, @OA\\Schema(type="integer")),
     *     @OA\\Response(response=200, description="Success")
     * )
     */
    public function destroy($id): JsonResponse
    {{
        try {{
            ${variable_name} = {base_name}::findOrFail($id);
            ${variable_name}->delete();

            return response()->json([
                'success' => true,
                'message' => '{base_name} deleted successfully'
            ]);
        }} catch (\\Exception $e) {{
            return response()->json([
                'success' => false,
                'message' => 'Failed to delete {base_name}',
                'error' => $e->getMessage()
            ], 500);
        }}
    }}
}}
'''
    
    def generate_controllers(self):
        """Generate controllers for all models"""
        self.log('ØªÙˆÙ„ÙŠØ¯ Controllers...')
        
        # Create controllers directory if it doesn't exist
        self.controllers_path.mkdir(parents=True, exist_ok=True)
        
        for model in self.models:
            try:
                base_name = model['base_name']
                controller_name = f"{base_name}ApiController"
                controller_file = self.controllers_path / f"{controller_name}.php"
                
                # Skip if already exists
                if controller_file.exists():
                    self.log(f"ØªØ®Ø·ÙŠ {controller_name} - Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„")
                    continue
                
                content = self.generate_controller_content(model)
                controller_file.write_text(content, encoding='utf-8')
                
                self.generated_controllers.append({
                    'name': controller_name,
                    'path': str(controller_file),
                    'model': base_name
                })
                
                self.stats['controllers_generated'] += 1
                self.log(f"ØªÙ… ØªÙˆÙ„ÙŠØ¯ {controller_name}")
                
            except Exception as e:
                error_msg = f"ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Controller Ù„Ù€ {model['base_name']}: {str(e)}"
                self.stats['errors'].append(error_msg)
                self.log(f"Ø®Ø·Ø£: {error_msg}")
        
        self.log(f"ØªÙ… ØªÙˆÙ„ÙŠØ¯ {self.stats['controllers_generated']} Controller")
    
    def generate_routes_content(self):
        """Generate routes file content"""
        today = datetime.now().strftime('%Y-%m-%d')
        
        content = f'''<?php

use Illuminate\\Support\\Facades\\Route;

/*
|--------------------------------------------------------------------------
| Auto-Generated API Routes
|--------------------------------------------------------------------------
| Version: 3.16.0
| Generated: {today}
| Total Models: {self.stats['models_found']}
|
| This file was automatically generated by API Generator v3.16.0
| DO NOT EDIT THIS FILE MANUALLY
*/

'''
        
        for model in self.models:
            base_name = model['base_name']
            controller_name = f"{base_name}ApiController"
            resource_name = self.to_kebab_case(self.pluralize(base_name))
            
            content += f'''
// {base_name} API Routes
Route::prefix('{resource_name}')->group(function () {{
    Route::get('/', [App\\Http\\Controllers\\Api\\{controller_name}::class, 'index']);
    Route::post('/', [App\\Http\\Controllers\\Api\\{controller_name}::class, 'store']);
    Route::get('/{{id}}', [App\\Http\\Controllers\\Api\\{controller_name}::class, 'show']);
    Route::put('/{{id}}', [App\\Http\\Controllers\\Api\\{controller_name}::class, 'update']);
    Route::delete('/{{id}}', [App\\Http\\Controllers\\Api\\{controller_name}::class, 'destroy']);
}});
'''
        
        return content
    
    def generate_routes(self):
        """Generate routes file"""
        self.log('ØªÙˆÙ„ÙŠØ¯ Routes...')
        
        routes_file = self.routes_path / 'api_generated.php'
        content = self.generate_routes_content()
        
        routes_file.write_text(content, encoding='utf-8')
        self.stats['routes_generated'] = len(self.models)
        
        self.log(f"ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù Routes: api_generated.php")
    
    def generate_documentation(self):
        """Generate documentation report"""
        self.log('ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙˆØ«ÙŠÙ‚...')
        
        today = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        
        # Generate models list
        models_list = ''
        for model in self.models:
            base_name = model['base_name']
            resource_name = self.to_kebab_case(self.pluralize(base_name))
            models_list += f"- **{base_name}**: `/api/{resource_name}`\\n"
        
        # Generate errors list
        errors_section = ''
        if self.stats['errors']:
            errors_section = "## âš ï¸ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡\\n\\n"
            for error in self.stats['errors']:
                errors_section += f"- {error}\\n"
        
        content = f'''# ğŸš€ API Generator v3.16.0 - ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙˆÙ„ÙŠØ¯

**Ø§Ù„ØªØ§Ø±ÙŠØ®:** {today}  
**Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 3.16.0  
**Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:** php-magic-system (SEMOP)

---

## ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª

| Ø§Ù„Ù…Ø¤Ø´Ø± | Ø§Ù„Ù‚ÙŠÙ…Ø© |
|--------|--------|
| Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ÙƒØªØ´ÙØ© | {self.stats['models_found']} |
| Controllers Ø§Ù„Ù…ÙˆÙ„Ø¯Ø© | {self.stats['controllers_generated']} |
| Routes Ø§Ù„Ù…ÙˆÙ„Ø¯Ø© | {self.stats['routes_generated']} |
| Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ | {len(self.stats['errors'])} |

---

## ğŸ“‹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„Ù€ API Endpoints

{models_list}

---

## ğŸ¯ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©

### 1. RESTful Controllers
ØªÙ… ØªÙˆÙ„ÙŠØ¯ Controllers ÙƒØ§Ù…Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙÙŠ:
```
app/Http/Controllers/Api/
```

ÙƒÙ„ Controller ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
- `index()` - Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø¹ pagination
- `store()` - Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯
- `show()` - Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ù…Ø­Ø¯Ø¯
- `update()` - ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„
- `destroy()` - Ø­Ø°Ù Ø³Ø¬Ù„

### 2. Routes
ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù Routes Ø´Ø§Ù…Ù„:
```
routes/api_generated.php
```

### 3. OpenAPI Documentation
ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚Ø§Øª OpenAPI (Swagger) Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ endpoints.

---

## ğŸ”§ Ø§Ù„ØªÙƒØ§Ù…Ù„

### Ø¥Ø¶Ø§ÙØ© Routes Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹

Ø£Ø¶Ù Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ø¥Ù„Ù‰ `routes/api.php`:

```php
require __DIR__.'/api_generated.php';
```

---

## ğŸ“– Ø§Ø³ØªØ®Ø¯Ø§Ù… API

### Ù…Ø«Ø§Ù„: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

```bash
GET /api/users
```

**Response:**
```json
{{
    "success": true,
    "data": [...],
    "meta": {{
        "current_page": 1,
        "per_page": 15,
        "total": 100,
        "last_page": 7
    }}
}}
```

### Ù…Ø«Ø§Ù„: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯

```bash
POST /api/users
Content-Type: application/json

{{
    "name": "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯",
    "email": "ahmed@example.com"
}}
```

**Response:**
```json
{{
    "success": true,
    "message": "User created successfully",
    "data": {{...}}
}}
```

---

## âœ… Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©

1. âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù€ Controllers Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©
2. âœ… Ø¥Ø¶Ø§ÙØ© Ù‚ÙˆØ§Ø¹Ø¯ Validation Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
3. âœ… Ø¥Ø¶Ø§ÙØ© Middleware Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø©
4. âœ… Ø¥Ø¶Ø§ÙØ© Tests Ù„Ù„Ù€ API
5. âœ… ØªÙˆÙ„ÙŠØ¯ Swagger Documentation

---

{errors_section}

## ğŸ‰ Ø§Ù„Ø®Ù„Ø§ØµØ©

ØªÙ… ØªÙˆÙ„ÙŠØ¯ **RESTful API ÙƒØ§Ù…Ù„** Ù„Ù€ **{self.stats['models_found']} Ù†Ù…ÙˆØ°Ø¬** Ø¨Ù†Ø¬Ø§Ø­!

Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ endpoints Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ù„ØªØ®ØµÙŠØµ.

---

**Generated by API Generator v3.16.0**  
**SEMOP Team Â© 2025**
'''
        
        doc_file = self.base_path / 'API_GENERATOR_v3.16.0_REPORT.md'
        doc_file.write_text(content, encoding='utf-8')
        
        self.log('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù Ø§Ù„ØªÙˆØ«ÙŠÙ‚: API_GENERATOR_v3.16.0_REPORT.md')
    
    def generate(self):
        """Run the complete generation process"""
        self.log('Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªÙˆÙ„ÙŠØ¯ API v3.16.0')
        
        # Discover models
        self.discover_models()
        
        # Generate controllers
        self.generate_controllers()
        
        # Generate routes
        self.generate_routes()
        
        # Generate documentation
        self.generate_documentation()
        
        self.log('Ø§ÙƒØªÙ…Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­')
        
        return self.stats


def main():
    """Main entry point"""
    base_path = '/home/ubuntu/php-magic-system'
    
    print("=" * 60)
    print("ğŸš€ API Generator v3.16.0")
    print("=" * 60)
    print()
    
    generator = ApiGenerator(base_path)
    stats = generator.generate()
    
    print()
    print("=" * 60)
    print("âœ… Ø§ÙƒØªÙ…Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!")
    print("=" * 60)
    print()
    print(f"Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ÙƒØªØ´ÙØ©: {stats['models_found']}")
    print(f"Controllers Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©: {stats['controllers_generated']}")
    print(f"Routes Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©: {stats['routes_generated']}")
    print(f"Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: {len(stats['errors'])}")
    print()
    
    if stats['errors']:
        print("âš ï¸  Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:")
        for error in stats['errors']:
            print(f"  - {error}")
        print()
    
    print("ğŸ“„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙˆÙ„ÙŠØ¯: API_GENERATOR_v3.16.0_REPORT.md")
    print()


if __name__ == '__main__':
    main()
