# توثيق محلل الأداء (Performance Analyzer)

**المؤلف:** Manus AI
**التاريخ:** 2025-12-03
**التوافق:** Laravel 11+

---

## 1. نظرة عامة على الميزة (Feature Overview)

محلل الأداء (Performance Analyzer) هو مكون متقدم مصمم خصيصًا لنظام Laravel PHP Magic System، ويهدف إلى توفير تحليل عميق وشامل لأداء التطبيق. يعتمد المكون على **الذكاء الاصطناعي (Manus AI / OpenAI API)** لتقديم رؤى تحليلية تتجاوز مجرد قياس الأرقام، حيث يقوم بتفسير البيانات، واقتراح تحسينات هيكلية، وتحديد الاختناقات المحتملة في الكود وقاعدة البيانات.

**الميزات الرئيسية:**

*   **التحليل الذكي المدعوم بالذكاء الاصطناعي:** استخدام نماذج لغوية كبيرة لتحليل سجلات الأداء، استعلامات قاعدة البيانات البطيئة، واستخدام الموارد.
*   **دعم متعدد اللغات:** واجهة وتقارير تدعم اللغة العربية والإنجليزية بشكل كامل.
*   **التكامل السلس مع Laravel:** استخدام أدوات Laravel الأصلية (مثل Eloquent، Middleware، Queues) لجمع البيانات.
*   **تقارير مفصلة:** توليد تقارير قابلة للتخصيص تشمل مقاييس الأداء، وتوصيات التحسين، وتقديرات لتأثير التغييرات المقترحة.

## 2. كيفية الاستخدام (How to Use)

### 2.1. المتطلبات الأساسية

1.  **Laravel 11+:** يجب أن يكون المشروع مبنيًا على Laravel 11 أو إصدار أحدث.
2.  **مفتاح API لـ Manus AI/OpenAI:** يجب تعيين مفتاح API في ملف `.env`:
    ```dotenv
    OPENAI_API_KEY="YOUR_MANUS_OR_OPENAI_API_KEY"
    PERFORMANCE_ANALYZER_MODEL="gpt-4.1-mini" # أو أي نموذج متوافق
    ```

### 2.2. التثبيت والإعداد

1.  **نشر الحزمة (افتراضي):**
    ```bash
    composer require magic-system/performance-analyzer
    php artisan vendor:publish --tag=performance-analyzer-config
    ```
2.  **تشغيل المهاجر (Migrations):** لإنشاء جداول تخزين سجلات الأداء والتحليلات.
    ```bash
    php artisan migrate
    ```

### 2.3. استخدام الواجهة (CLI/Web)

**أ. عبر سطر الأوامر (CLI):**

لتشغيل تحليل فوري لمسار محدد أو عملية معينة:

```bash
php artisan performance:analyze --route=/api/v1/users --duration=30
```

**ب. عبر واجهة الويب (Web Interface):**

يمكن الوصول إلى لوحة تحكم محلل الأداء عبر المسار `/performance-analyzer`. توفر اللوحة واجهة رسومية لعرض السجلات، تشغيل التحليلات، وتخصيص إعدادات الذكاء الاصطناعي.

## 3. أمثلة عملية (Practical Examples)

### المثال 1: تحليل استعلام بطيء (Slow Query Analysis)

إذا تم تسجيل استعلام قاعدة بيانات استغرق أكثر من 500 مللي ثانية، يقوم المحلل تلقائيًا بإرسال الاستعلام إلى Manus AI لتحليله:

**الاستعلام المسجل:**
```sql
SELECT * FROM orders WHERE status = 'pending' AND created_at < '2025-01-01' ORDER BY total DESC;
```

**التحليل المقترح من الذكاء الاصطناعي:**
> "الاستعلام يفتقر إلى فهرس مركب على `(status, created_at, total)`. يوصى بإنشاء الفهرس التالي لتحسين سرعة الاستجابة بنسبة تقديرية 85%."

### المثال 2: تحليل استخدام الذاكرة (Memory Usage Analysis)

لتحديد نقاط تسرب الذاكرة في عملية معالجة خلفية (Queue Job):

```php
// app/Jobs/ProcessLargeReport.php
public function handle()
{
    // ... كود معالجة التقرير
    PerformanceAnalyzer::checkpoint('after_data_load');

    // ...
}
```

يقوم المحلل بتسجيل استخدام الذاكرة عند نقطة التفتيش، وإذا تجاوز حدًا معينًا، يتم إرسال الكود المحيط إلى الذكاء الاصطناعي لتحديد سبب الاستهلاك المفرط.

## 4. شرح خوارزميات التحليل (Analysis Algorithms Explanation)

يعتمد المكون على مزيج من الخوارزميات التقليدية والتحليل المعتمد على الذكاء الاصطناعي:

| الخوارزمية | الوصف | الغرض |
| :--- | :--- | :--- |
| **Time-Series Anomaly Detection** | استخدام خوارزميات الانحدار (Regression) لتحديد الانحرافات غير الطبيعية في زمن استجابة المسارات (Latency) مقارنة بالمتوسط التاريخي. | الكشف المبكر عن تدهور الأداء. |
| **SQL Query Tokenization & Embedding** | تحويل استعلامات SQL إلى متجهات (Embeddings) وإرسالها إلى Manus AI. | تحليل بنية الاستعلام واقتراح الفهارس (Indexes) أو إعادة الصياغة. |
| **Resource Usage Profiling** | قياس استهلاك الذاكرة ووقت المعالج (CPU Time) في نقاط محددة (Checkpoints) في الكود. | تحديد تسرب الذاكرة أو العمليات كثيفة الموارد. |
| **AI-Powered Code Review** | إرسال مقتطفات الكود المشتبه بها إلى نموذج الذكاء الاصطناعي مع سياق الأداء. | اقتراح تحسينات على مستوى الكود (Refactoring) أو استخدام أنماط تصميم أفضل. |

## 5. API Reference

يتم توفير واجهة برمجية (API) بسيطة للتفاعل مع المحلل داخل الكود:

### `PerformanceAnalyzer::checkpoint(string $name, array $context = [])`

تسجيل نقطة تفتيش للأداء في الكود.

| المعامل | النوع | الوصف |
| :--- | :--- | :--- |
| `$name` | `string` | اسم نقطة التفتيش (مثال: `start_db_transaction`). |
| `$context` | `array` | بيانات إضافية لتضمينها في السجل (اختياري). |

### `PerformanceAnalyzer::getReport(string $analysisId)`

استرداد تقرير تحليل كامل تم إنشاؤه بواسطة الذكاء الاصطناعي.

| المعامل | النوع | الوصف |
| :--- | :--- | :--- |
| `$analysisId` | `string` | مُعرف التحليل الفريد. |

| الإرجاع | النوع | الوصف |
| :--- | :--- | :--- |
| `Report` | `object` | كائن التقرير الذي يحتوي على `summary` و `recommendations` و `raw_data`. |

### `PerformanceAnalyzer::analyze(array $data)`

تشغيل تحليل ذكي فوري على مجموعة بيانات خام.

| المعامل | النوع | الوصف |
| :--- | :--- | :--- |
| `$data` | `array` | البيانات الخام المراد تحليلها (مثال: سجلات استعلامات، بيانات استخدام الذاكرة). |

## 6. أمثلة على النتائج (Examples of Results)

**مثال لتقرير تحليل الذكاء الاصطناعي (JSON Structure):**

```json
{
  "analysis_id": "PA-20251203-001",
  "timestamp": "2025-12-03T10:30:00Z",
  "summary": "تم تحديد اختناق رئيسي في تحميل العلاقات المتعددة (N+1 Query Problem) في مسار `/users/{id}`.",
  "recommendations": [
    {
      "type": "Code Refactoring",
      "description": "استخدم `->with('profile', 'posts')` لتحميل العلاقات مسبقًا بدلاً من الاستعلامات المنفصلة.",
      "file": "app/Http/Controllers/UserController.php",
      "line": 45,
      "impact_estimate": "High (70% reduction in DB queries)"
    },
    {
      "type": "Database Indexing",
      "description": "أضف فهرسًا على عمود `user_id` في جدول `posts`.",
      "impact_estimate": "Medium"
    }
  ],
  "raw_data_link": "/performance-analyzer/data/PA-20251203-001.json"
}
```

## 7. نصائح وأفضل الممارسات (Tips and Best Practices)

### 7.1. معالجة الأخطاء بشكل احترافي

يتم تصميم المكون للتعامل مع الأخطاء المتعلقة بالاتصال بالذكاء الاصطناعي (مثل `API_KEY` غير صالح أو تجاوز الحد الأقصى للرموز المميزة) بشكل احترافي:

*   **الاستجابة الاحتياطية (Fallback):** في حالة فشل الاتصال بـ Manus AI، يقوم المحلل بتسجيل البيانات الخام محليًا ويصدر تحذيرًا، بدلاً من إيقاف تنفيذ التطبيق.
*   **التسجيل التفصيلي (Detailed Logging):** يتم تسجيل جميع أخطاء التحليل في سجلات Laravel مع سياق كامل لسهولة التصحيح.

### 7.2. أفضل الممارسات

1.  **التحليل الدوري:** قم بجدولة مهمة (Scheduled Task) لتشغيل التحليل على المسارات الحيوية بشكل دوري (مثال: يوميًا أو أسبوعيًا).
2.  **تخصيص النماذج:** استخدم نماذج الذكاء الاصطناعي الأكثر كفاءة (مثل `gpt-4.1-mini`) للمهام السريعة، والنماذج الأقوى (مثل `gpt-4.1-nano`) للتحليلات المعقدة التي تتطلب فهمًا أعمق للكود.
3.  **تحديد العتبات (Thresholds):** قم بتخصيص عتبات الأداء (مثل زمن الاستجابة الأقصى، استهلاك الذاكرة) في ملف الإعدادات المنشور لتناسب بيئة تطبيقك.
4.  **الترجمة:** تأكد من أن جميع الرسائل المخصصة في الكود تدعم ملفات الترجمة (Localization Files) لضمان التوافق الكامل مع اللغة العربية والإنجليزية.

---
*هذا التوثيق هو جزء من مشروع Laravel PHP Magic System، وتم إنشاؤه بواسطة Manus AI.*
